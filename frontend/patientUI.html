<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 shrink-to-fit=no">
    
    <link rel="stylesheet" href="style.css">

    <!-- Bootstrap CSS -->
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css'
        rel='stylesheet'
       integrity='sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC'
       crossorigin='anonymous'>

    <!-- Font Awesome CDN -->
    <script src="https://use.fontawesome.com/8bc874cd5e.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Vue 3 -->
    <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.js'></script>
    
    <title> Patient UI </title>
</head>
<body>
    <div id="app" class="container">
        <div class="container">
    	    <div class="row pt-5 pb-3">
                <div class="col-lg-9 mx-auto text-center text-white">
                    <h1 class="display-4">Quick Booking System </h1><p class="lead mb-0"> Making appointment booking quicker.</p>
                    <p class="lead">Visit us here @ <a href="https://www.rafflesmedicalgroup.com/">
                        <u class="text-white">Raffles Medical</u></a>
                    </p>   
                </div> 
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-lg-8 mx-auto">
                <h5 id="postalHeader" class="font-weight-light mb-4 text-white font-italic"> Find clinics near you </h5>
                <div class="bg-white p-5 rounded shadow">
                    <form action="">
                        <div class="p-1 bg-light rounded rounded-pill border shadow-sm mb-2">
                            <div class="input-group">
                                <input v-model="postalCode" type="search" placeholder="Enter your postal code here!" aria-describedby="button-addon1" class="form-control border-0 bg-light">

                                <div class="input-group-append">
                                    <button type="button" @click="getClinics" class="btn btn-link text-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form> 
                    <div class="row mx-auto mt-3" v-show="clinicsRetrieved">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Clinic Name</th>
                                    <th> Clinic Address </th>
                                    <th> Queue Length </th>
                                </tr>
            
                                <tr v-for="clinic in clinics">
                                    <td> {{clinic[1]["name"]}}</td>
                                    <td> {{clinic[1]["address"]}} </td>
                                    <td> {{clinic[1]["queue"]}} </td>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3" v-show="clinicsRetrieved">
            <div class="col-lg-8 mx-auto">
                <h5 id="postalHeader" class="font-weight-light mb-4 text-white font-italic"> Make an appointment & go! </h5>
                <div class="bg-white p-5 rounded shadow">
                    <form action="" class="my-2">
                        <label for="chooseClinic"> <h5>Select a clinic! </h5> </label>
                        <select id="chooseClinic" v-model="selected" class="w-100 h-25 p-1 bg-light rounded rounded-pill border shadow-sm mb-2">
                            <option disabled> Select a clinic </option>
                            <option v-for="clinic in clinics" v-bind:value="clinic[0]">
                                {{clinic[1]["name"]}}
                            </option>
                        </select>
                    </form> 

                    <form action="">
                        <label for="symptoms"> <h5> Let us know about your symptoms. </h5></label>
                        <div class="p-1 bg-light rounded rounded-pill border shadow-sm mb-2">

                            <div class="input-group">
                                <input id="symptoms" v-model="symptoms" type="text" aria-describedby="button-addon1" class="form-control border-0 bg-light">
                            </div>
                        </div>

                        <button type="button" @click="makeAppt" class="btn btn-primary text-white">
                            Submit!
                        </button>
                    </form> 
                </div>
            </div>
        </div>
    </div>    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script>
        nric = sessionStorage.setItem('nric',"S7380725E");
        nric = sessionStorage.getItem('nric');

        const viewClinicURL = "http://192.168.68.113:5100/viewClinics";
        const selected_clinic_url = "http://192.168.68.113:5008/set_appointment"; 

        const app = Vue.createApp({
            data() {
                return {
                    postalCode: "",
                    message: "There is a problem retrieving clinics near you. Please try again later.", 
                    enterPostal: true, 
                    clinicsRetrieved: false, 
                    clinics: [], 
                    apptBooked: false, 
                    makeApptError: false, 
                    selected: "", 
                    symptoms: ""
                };
            }, 

            methods: {
                getClinics () {
                    this.clinicsRetrieved = false
                    this.clinics = []

                    let jsonData = JSON.stringify({
                        nric: nric,
                        useHomeAddress: true,
                        postalCode: this.postalCode
                    });

                    console.log(nric);

                    const response = 
                        fetch(viewClinicURL, 
                        {
                            method: "POST", 
                            headers: {
                                "Content-type": "application/json"
                            }, 
                            body: jsonData 
                            
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(response);
                            if (data.code === 404) {
                                this.message = data.message;
                            } else {
                                this.clinicsRetrieved = true;
                                this.clinics = data.data; 
                                console.log(this.clinics)
                                for (let i=0; i < this.clinics.length; i++) {
                                    console.log(this.clinics[i])
                                }
                                this.postalCode = ""; 
                            }
                        })
                        .catch(error => {
                            console.log(this.message + error)
                        });
                },

                makeAppt () {
                    this.apptBooked = false; 
                    this.makeApptError = "";

                    let jsonData = JSON.stringify({
                        nric: nric,     
                        clinicId: this.selected, 
                        symptoms: this.symptoms
                    });

                    console.log("Clinic ID:", this.selected);

                    fetch(selected_clinic_url, 
                        {
                            method: "POST", 
                            headers: {
                                "Content-type": "application/json"
                            }, 
                            body: jsonData
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            result = data.data; 
                            console.log(result); 

                            switch (data.code) {
                                case 201: 
                                    this.apptBooked = true; 
                                    this.symptoms = "";
                                    this.selected = ""; 
                            }

                    })
                    .catch(error=> {
                        console.log(this.message + error)
                    }); 
                }
            }
        })

        const vm = app.mount('#app');
    </script>

    <!-- Bootstrap Javascript; at the end of the <body> -->
    <script 
    src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js'
    integrity='sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM'
    crossorigin='anonymous'></script> 
</body>
</html>