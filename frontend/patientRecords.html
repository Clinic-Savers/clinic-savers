<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css'
        rel='stylesheet'
        integrity='sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC'
        crossorigin='anonymous'>

    <!-- Vue 3 -->
    <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.js'></script>
    <!-- Vue 3: production version, optimized for size and speed -->
    <!-- <script src='https://cdn.jsdelivr.net/npm/vue@3.0.2/dist/vue.global.prod.js'></script> -->

</head>

<body>
    <!-- 1st page: Login Page (Session store Clinic ID)
    2nd Page: Doctor or CA
    Doctor Page: Dropdown Search PR & Prescribe Drug
    CA Page: Search Drug, Edit button (make Supplier info into input text and reorderQuantity), "Restock Completed" button -->
  <body>
    <div id="app" class="container">
        <h1>Patient Records</h1>
        <ul class="nav nav-tabs">
            <li class="nav-item">
              <a class="nav-link" href="./prescribeDrug copy.html">Prescribe Drugs</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="./patientRecords.html">Patient Records</a>
            </li>
        </ul>
        <div class="row">
            <div id="main" class="col-8">
                <form>
                    NRIC: <input type = "text" id="nric" placeholder="NRIC">
                    <br>
                    Drug Name: <input type = "text" id="drugName" placeholder="Drug Name">
                    <button type="button"
                        class="my-1 btn btn-sm btn-primary" onclick="findRecords()">Search</button><br>  
                    <button class="my-1 btn btn-sm btn-primary" onclick="getAllRecords()">Show all Records</button>
                </form>
                

                <table class="table table-striped">
                    <!-- <table class="table table-striped"> -->
                    <thead id= 'all'>
                        
                        
                    </thead>
                </table>
            </div> <!-- main & col -->
        </div> <!-- row -->
        <div id="test">

        </div>

    </div>
    <script>
        const patientRecord_URL ="http://localhost:5006/patientRecord"
        const prescribeDrug_URL = "http://localhost:5120/create_record"
        const updateRecord_URL ="http://localhost:5120/update_record"
        const deleteRecord_URL = "http://localhost:5120/delete_record"

        //functions
        async function getAllRecords(){
            const response =
                        await fetch(patientRecord_URL)
                            .then(response => response.json())
                            .then(data => {
                                console.log(data.data.PatientRecords)
                                result =JSON.parse(JSON.stringify(data.data.PatientRecords))
                                message_str =  `<tr>
                                    <th>clinicId</th>
                                    <th>nric</th>
                                    <th>drugName</th>
                                    <th>prescribed quantity</th>
                                    <th>date</th>
                                    <th>time</th>
                                </tr>`
                                console.log(result)
                                for (const record of result) {
                                    message_str += `
                                    <tr id ="${record['clinicId']},${record['nric']},${record['drugName']},${record['date']},${record['time']}">
                                        <td>
                                            ${record['clinicId']}
                                        </td>
                                        <td>
                                            ${record['nric']}
                                        </td>
                                        <td>
                                            ${record['drugName']}
                                        </td>
                                        <td>
                                            ${record['prescribeQuantity']}
                                        </td>
                                        <td>
                                            ${record['date']}
                                        </td>
                                        <td>
                                            ${record['time']}
                                        </td>
                                        <td>
                                            <button type="button"
                                            class="btn btn-danger" id="delete,${record['clinicId']},${record['nric']},${record['drugName']},${record['prescribeQuantity']},${record['date']},${record['time']}" onclick="delete_record(this)">Delete
                                            </button>
                                        </td>
                                        <td>
                                            <button type="button"
                                            class="btn btn-primary" id="update,${record['clinicId']},${record['nric']},${record['drugName']},${record['prescribeQuantity']},${record['date']},${record['time']}" onclick="update_record(this)">Edit
                                            </button>
                                        </td>
                                    </tr>`
                                    //
                                }
                                document.getElementById('all').innerHTML = message_str

                                return data.data.PatientRecords
                            })
                            .catch(error => {
                                // Errors when calling the service; such as network error, 
                                // service offline, etc
                                console.log(error);

                            });
        }
        getAllRecords()

        async function findRecords(){
            var drugName = document.getElementById('drugName').value
            var nric = document.getElementById('nric').value
            console.log(drugName)
            console.log(nric)
            const response =
                        await fetch(`${patientRecord_URL}/${nric}/${drugName}`)
                            .then(response => response.json())
                            .then(data => {
                                console.log(data)
                                result =JSON.parse(JSON.stringify(data.data.PatientRecords))
                                console.log(result)
                                message_str =  `<tr>
                                    <th>clinicId</th>
                                    <th>nric</th>
                                    <th>drugName</th>
                                    <th>prescribed quantity</th>
                                    <th>date</th>
                                    <th>time</th>
                                </tr>`
                                console.log(result)
                                
                                message_str += `
                                <tr id ="${result[0]['drugName']},${result[0]['clinicId']}">
                                    <td>
                                        ${result[0]['clinicId']}
                                    </td>
                                    <td>
                                        ${result[0]['nric']}
                                    </td>
                                    <td>
                                        ${result[0]['drugName']}
                                    </td>
                                    <td>
                                        ${result[0]['prescribeQuantity']}
                                    </td>
                                    <td>
                                        ${result[0]['date']}
                                    </td>
                                    <td>
                                        ${result[0]['time']}
                                    </td>
                                    <td>
                                        <button type="button"
                                        class="btn btn-danger" id="${result[0]['clinicId']},${result[0]['nric']},${result[0]['drugName']},${result[0]['prescribeQuantity']},${result[0]['date']},${result[0]['time']}" onclick="delete_record(this)">Delete
                                        </button>
                                    </td>
                                    <td>
                                        <button type="button"
                                        class="btn btn-primary" id="${result[0]['nric']}" onclick="update_record(this)">Edit
                                        </button>
                                    </td>
                                </tr>`
                                
                                document.getElementById('all').innerHTML = message_str

                                return data.data.PatientRecords
                            })
                            .catch(error => {
                                // Errors when calling the service; such as network error, 
                                // service offline, etc
                                console.log(error);

                            });
        }

        async function delete_record(item){
            var nric = item.id.split(",")[2]
            var time = item.id.split(",")[6]
            var date = item.id.split(",")[5]
            var clinicId = parseInt(item.id.split(",")[1])
            var drugName = item.id.split(",")[3]
            var prescribeQuantity = parseInt(item.id.split(",")[4])
            console.log([nric, time, date, clinicId, drugName, prescribeQuantity])
            fetch(deleteRecord_URL, {
                method: 'POST', // or 'PUT'
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({"nric": nric,"clinicId": clinicId,"drugName":drugName,"prescribeQuantity":prescribeQuantity,"date":date,"time":time}),
              })
              .then(response => response.json())
              .then(data => {
                console.log('Success:', data);
                if (data.code === 201) {
                    document.getElementById(`${clinicId},${nric},${drugName},${date},${time}`).remove()
                    alert(`${clinicId},${nric},${drugName},${date},${time} successfully deleted record!`)
                }
                
              })
              .catch((error) => {
                console.error('Error:', error);
              });   
        }
        function update_record(item){
            var nric = item.id.split(",")[2]
            var time = item.id.split(",")[6]
            var date = item.id.split(",")[5]
            var clinicId = parseInt(item.id.split(",")[1])
            var drugName = item.id.split(",")[3]
            var prescribeQuantity = parseInt(item.id.split(",")[4])
            update_btn = `
                <button type="button"
                class="btn btn-warning" id="save,${clinicId},${nric},${drugName},${prescribeQuantity},${date},${time}" onclick="save_record(this)">Update
                </button>
            `
            item.parentElement.parentElement.children[6].innerHTML = update_btn
            qty_input = `
                <input type = "text" id="qty,${clinicId},${nric},${drugName},${date},${time}" value="${prescribeQuantity}">
            `
            item.parentElement.parentElement.children[3].innerHTML = qty_input
            cancel_btn = `
                <button type="button"
                class="btn btn-light" id="cancel,${clinicId},${nric},${drugName},${prescribeQuantity},${date},${time}" onclick="cancel_record(this)">Cancel
                </button>
            `
            item.parentElement.parentElement.children[7].innerHTML = cancel_btn
        }
        function cancel_record(item){
            var nric = item.id.split(",")[2]
            var time = item.id.split(",")[6]
            var date = item.id.split(",")[5]
            var clinicId = parseInt(item.id.split(",")[1])
            var drugName = item.id.split(",")[3]
            var prescribeQuantity = parseInt(item.id.split(",")[4])
            delete_btn = `
                <button type="button"
                class="btn btn-danger" id="delete,${clinicId},${nric},${drugName},${prescribeQuantity},${date},${time}" onclick="delete_record(this)">Delete
                </button>
            `
            item.parentElement.parentElement.children[6].innerHTML = delete_btn
            item.parentElement.parentElement.children[3].innerHTML = prescribeQuantity
            edit_btn = `
                <button type="button"
                class="btn btn-primary" id="update,${clinicId},${nric},${drugName},${prescribeQuantity},${date},${time}" onclick="update_record(this)">Edit
                </button>
            `
            item.parentElement.parentElement.children[7].innerHTML = edit_btn
        }
        async function save_record(item){
            var nric = item.id.split(",")[2]
            var time = item.id.split(",")[6]
            var date = item.id.split(",")[5]
            var clinicId = parseInt(item.id.split(",")[1])
            var drugName = item.id.split(",")[3]
            var prescribeQuantity = parseInt(document.getElementById(`qty,${clinicId},${nric},${drugName},${date},${time}`).value)
            console.log([nric, time, date, clinicId, drugName, prescribeQuantity])
            fetch(updateRecord_URL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({"nric": nric,"clinicId": clinicId,"drugName":drugName,"prescribeQuantity":prescribeQuantity,"date":date,"time":time}),
              })
              .then(response => response.json())
              .then(data => {
                console.log('Success:', data);
                if (data.code === 201) {
                    document.getElementById(`${clinicId},${nric},${drugName},${date},${time}`).children[3].innerText = prescribeQuantity
                    delete_btn = `
                        <button type="button"
                        class="btn btn-danger" id="delete,${clinicId},${nric},${drugName},${prescribeQuantity},${date},${time}" onclick="delete_record(this)">Delete
                        </button>
                    `
                    document.getElementById(`${clinicId},${nric},${drugName},${date},${time}`).children[6].innerHTML = delete_btn
                    edit_btn = `
                        <button type="button"
                        class="btn btn-primary" id="update,${clinicId},${nric},${drugName},${prescribeQuantity},${date},${time}" onclick="update_record(this)">Edit
                        </button>
                    `
                    document.getElementById(`${clinicId},${nric},${drugName},${date},${time}`).children[7].innerHTML = edit_btn
                    alert(`${clinicId},${nric},${drugName},${prescribeQuantity},${date},${time} successfully updated record!`)
                }
                
              })
              .catch((error) => {
                console.error('Error:', error);
              });   
        }
    </script>

    <!-- Bootstrap Javascript -->
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js'
        integrity='sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM'
        crossorigin='anonymous'>
    </script>

</body>

</html>