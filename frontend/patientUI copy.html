<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 shrink-to-fit=no">
    
    <link rel="stylesheet" href="style.css">

    <!-- Bootstrap CSS -->
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css'
        rel='stylesheet'
       integrity='sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC'
       crossorigin='anonymous'>

    <!-- Font Awesome CDN -->
    <script src="https://use.fontawesome.com/8bc874cd5e.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    
    <title> Patient UI </title>
</head>
<body>
    <div id="app" class="container">
        <div class="container">
    	    <div class="row pt-5 pb-3">
                <div class="col-lg-9 mx-auto text-center text-white">
                    <h1 class="display-4">Quick Booking System </h1><p class="lead mb-0"> Making appointment booking quicker.</p>
                    <p class="lead">Visit us here @ <a href="https://www.rafflesmedicalgroup.com/">
                        <u class="text-white">Raffles Medical</u></a>
                    </p>   
                </div> 
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-lg-8 mx-auto">
                <h5 id="postalHeader" class="font-weight-light mb-4 text-white font-italic"> Find clinics near you </h5>
                <div class="bg-white p-5 rounded shadow">
                        <div class="p-1 bg-light rounded rounded-pill border shadow-sm mb-2">
                            <div class="input-group">
                                <input id="postalCode" type="search" placeholder="Enter your postal code here!" aria-describedby="button-addon1" class="form-control border-0 bg-light">

                                <div class="input-group-append">
                                    <button type="button" onclick="getClinics()" class="btn btn-link text-primary">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-check">
                            <button class="btn btn-primary" onclick="getClinics()" id="homeAddress">
                                Use Home Address
                            </button>
                        </div>
                    <!-- build the message in js -->
                    <div class="row mx-auto mt-3">
                        <table class="table table-striped">
                            <thead id="listClinics">
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- build message in js -->
        <div class="row mb-3" id="clinicsRetrieved">
            <div class="col-lg-8 mx-auto">
                <h5 id="postalHeader" class="font-weight-light mb-4 text-white font-italic"> Make an appointment & go! </h5>
                <div class="bg-white p-5 rounded shadow">
                    <form action="" class="my-2">
                        <label for="chooseClinic"> <h5>Select a clinic! </h5> </label>
                        <select id="chooseClinic" class="w-100 h-25 p-1 bg-light rounded rounded-pill border shadow-sm mb-2">
                            <option disabled> Select a clinic </option>
                            <option>
                                {{clinic[1]["name"]}}
                            </option>
                        </select>
                    </form> 

                    <form action="">
                        <label for="symptoms"> <h5> Let us know about your symptoms. </h5></label>
                        <div class="p-1 bg-light rounded rounded-pill border shadow-sm mb-2">

                            <div class="input-group">
                                <input id="symptoms" type="text" aria-describedby="button-addon1" class="form-control border-0 bg-light">
                            </div>
                        </div>

                        <button type="button" onclick="makeAppt()" class="btn btn-primary text-white">
                            Submit!
                        </button>
                    </form> 

                    <!-- show appointment details -->

                    <div class="row mx-auto mt-3" >
                        <h5> Your appointment details </h5>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th> Appointment Date </th>
                                    <th> Appointment Time </th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr>
                                    <td> {{appt.appointmentDate}} </td>
                                    <td> {{appt.appointmentTime}} </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Open Modal</button>

        <!-- add subsidy card page -->
        <div class="row mb-3">
            <div class="col-lg-8 mx-auto">
                <h5 id="postalHeader" class="font-weight-light mb-4 text-white font-italic"> Add your subsidy card <span class="fst-italic">(optional)</span> </h5>
                <div class="bg-white p-5 rounded shadow">
                    <form action="">
                        <label for="symptoms"> <h5> Subsidy Card Number </h5></label>
                        <div class="p-1 bg-light rounded rounded-pill border shadow-sm mb-2">
                            <div class="input-group">
                                <input id ="cardNumber" type="text" placeholder="Enter your subsidy card number here!" aria-describedby="button-addon1" class="form-control border-0 bg-light">
                            </div>
                        </div>

                        <label for="cardType" class="mt-2"> <h5> Subsidy Card Type </h5></label>
                        <select id="cardType" class="w-100 h-25 p-1 bg-light rounded rounded-pill border shadow-sm mb-2">
                            <option disabled> Select a card type </option>
                            <option> Green CHAS </option>
                            <option> Orange CHAS </option>
                            <option> Blue CHAS </option>
                            <option> Merdeka </option>
                            <option> Pioneer </option>
                            <option> Company </option>
                        </select>

                        <label for="organisationType" class="mt-2"> <h5> Organisation </h5></label>
                        <div class="p-1 bg-light rounded rounded-pill border shadow-sm mb-2">
                            <div class="input-group">
                                <input id="organisationType" type="text" placeholder="Optional" aria-describedby="button-addon1" class="form-control border-0 bg-light">
                            </div>
                        </div>

                        <label for="expiryDate" class="mt-2"> <h5> Expiry Date of Subsidy Card </h5></label>
                        <div class="p-1 bg-light rounded rounded-pill border shadow-sm mb-2">
                            <div class="input-group">
                                <input id="expiryDate" type="text" placeholder="dd/mm/yyyy" aria-describedby="button-addon1" class="form-control border-0 bg-light">
                            </div>
                        </div>

                        <button type="button" onclick="addSubsidy()" class="btn btn-primary text-white">
                            Submit!
                        </button>
                    </form> 
                    <!-- alert -->
                    <div class="row mx-auto mt-3">
                        <h5> Your subsidy card has been added. </h5>
                    </div>
                </div>
            </div>
        </div>
    </div>    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script>
        nric = sessionStorage.setItem('nric',"S7380725E");
        nric = sessionStorage.getItem('nric');

        const viewClinicURL = "http://localhost:5100/viewClinics";
        const selected_clinic_url = "http://localhost:5008/set_appointment"; 

        // const subsidy_url = "http://localhost:5004/subsidy/create";
        
        async function getClinics(){
            var nric = sessionStorage.getItem('nric')
            var postalCode = document.getElementById("postalCode").value
            const response =
                    await fetch(viewClinicURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({"nric": nric,"postalCode":postalCode}),
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Success:', data);
                            if (data.code === 200) {
                                console.log(data)
                                clinics = data.data
                                message_str =  `
                                <tr>
                                    <th>Clinic Name</th>
                                    <th> Clinic Address </th>
                                    <th> Queue Length </th>
                                </tr>`
                                var i = 0
                                for (const clinic of clinics) {
                                    i++
                                    message_str += `
                                    <tr id ="${clinic[0]}">
                                        <td>
                                            ${clinic[1]['name']}
                                        </td>
                                        <td>
                                            ${clinic[1]['address']}
                                        </td>
                                        <td>
                                            ${clinic[1]['queue']}
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-primary"  id="${i},${nric},${clinic[0]}" onclick="toggle_form(this)">
                                                Book Appointment
                                            </button>
                                        </td>
                                    </tr>
                                    `
                                }
                                document.getElementById("listClinics").innerHTML= message_str

                                book_appt_modal = `

                                `
                            }else if (data.code===500){
                                msg_str = "<p style = 'color:red'> No clinics nearby!<p>"
                                document.getElementById("listClinics").innerHTML= msg_str
                            }
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                        });
        }


        function toggle_form(item){
            console.log(item)
            clinicId = item.id.split(',')[2]
            nric = item.id.split(',')[1]
            index = item.id.split(',')[0]
            row = document.getElementById(`${clinicId}`)
            var table = document.getElementById("listClinics");
            for (let i = 1; i < table.children.length; i++) {
                table.children[i].children[3].remove()
            }
            var row =table.insertRow(parseInt(index)+1)
            row.innerHTML = `
            <td colspan='3'>
                <label for="symptoms"> <h5> Let us know about your symptoms. </h5></label>
                <div class="p-1 bg-light rounded rounded-pill border shadow-sm mb-2">

                    <div class="input-group">
                        <input id="symptoms" type="text" aria-describedby="button-addon1" class="form-control border-0 bg-light">
                    </div>
                </div>
            </td>
            <td>
                <button class="btn btn-success" id="${nric},${symptoms},${clinicId}" onclick="bookAppointment(this)">Submit</button>
            </td>
            <td>
                <button class="btn btn-secondary" onclick="getClinics()">Cancel</button>
            </td>
            `
        }

        async function bookAppointment(item){
            console.log(item)
            clinicId = item.id.split(',')[2]
            nric = item.id.split(',')[0]
            symptoms = item.id.split(',')[1]
            const response =
                    await fetch(selected_clinic_url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({"nric": nric, "clinicId":clinicId, "symptoms": symptoms}),
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Success:', data);
                            if (data.code === 255 || data.code === 256 || data.code === 257) {
                                console.log(data)
                                message = data["message"]
                                alert(message)
                                location.href = "./"
                            }
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                        });
        }

        // async function {

        //     let jsonData =  JSON.stringify({
        //         nric: nric,
        //         postalCode: this.postalCode
        //     });

        //     console.log(nric);

        //     const response = 
        //         await fetch(viewClinicURL, 
        //         {
        //             method: "POST", 
        //             headers: {
        //                 "Content-type": "application/json"
        //             }, 
        //             body: jsonData 
                    
        //         })
        //         .then(response => response.json())
        //         .then(data => {
        //             console.log(response);
        //             if (data.code === 404) {
        //                 this.message = data.message;
        //             } else {
        //                 this.clinicsRetrieved = true;
        //                 this.clinics = data.data; 
        //                 console.log(this.clinics)
        //                 for (let i=0; i < this.clinics.length; i++) {
        //                     console.log(this.clinics[i])
        //                 }
        //                 this.postalCode = ""; 
        //             }
        //         })
        //         .catch(error => {
        //             console.log(this.message + error)
        //         });

        //         makeAppt () {
        //             this.apptBooked = false; 
        //             this.makeApptError = "";

        //             let jsonData = JSON.stringify({
        //                 nric: nric,     
        //                 clinicId: this.selected, 
        //                 symptoms: this.symptoms
        //             });

        //             console.log("Clinic ID:", this.selected);

        //             fetch(selected_clinic_url, 
        //                 {
        //                     method: "POST", 
        //                     headers: {
        //                         "Content-type": "application/json"
        //                     }, 
        //                     body: jsonData
        //                 })
        //                 .then(response => response.json())
        //                 .then(data => {
        //                     console.log(data);
        //                     result = data.data; 
        //                     console.log(result); 

        //                     switch (data.code) {
        //                         case 201: 
        //                             this.apptBooked = true; 
        //                             this.symptoms = "";
        //                             this.selected = ""; 
        //                     }

        //             })
        //             .catch(error=> {
        //                 console.log(this.message + error)
        //             }); 
        //         }, 

        //         addSubsidy() {
        //             this.subsidy = [];

        //             if (this.cardType != 'Company') {
        //                 this.organisationType = null;
        //             }

        //             let jsonData = JSON.stringify({
        //                 // cardNumber: this.cardNumber, 
        //                 nric: nric,
        //                 cardType: this.selectedCard, 
        //                 organisationType: this.organisationType, 
        //                 expiryDate: this.expiryDate
        //             })

        //             console.log(jsonData); 
        //             console.log(`${subsidy_url}/${this.cardNumber}`); 
        //             fetch(`${subsidy_url}/${this.cardNumber}`, 
        //                 {
        //                     method: "POST", 
        //                     headers: {
        //                         "Content-type": "application/json"
        //                     }, 
        //                     body: jsonData
        //                 }
        //             )
        //             .then(response => response.json())
        //             .then(data => {
        //                 console.log(data)
        //                 result = data.data; 
        //                 console.log(result); 

        //                 if (data.code === 404) {
        //                         this.message = data.message
        //                     } else {
        //                         this.subsidyMade = true;
        //                         this.subsidy = result; 
        //                         console.log(this.subsidy);  
        //                         this.cardNumber = "";
        //                         this.cardType = ""; 
        //                         this.organisationType = "";
        //                         this.expiryDate = "";
        //                         this.subsidy = []; 
        //                     }
        //                 })
        //             .catch(error=> {
        //                 console.log(this.message + error)
        //             })
        //         }
        //     }
        // })

        // const vm = app.mount('#app');
    </script>

    <!-- Bootstrap Javascript; at the end of the <body> -->
    <script 
    src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js'
    integrity='sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM'
    crossorigin='anonymous'></script> 
</body>
</html>